<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
  <head>
    <title>Tumblmathing</title>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.1/jquery.min.js"></script>
  </head>
  <script type="text/javascript">
    var CompiledRoute = function(regex, captures){
      this.regex = regex;
      this.captures = captures;
      
      var thisRoute = this;
      
      this.doesMatch = function(request){
        if(m = request.match(thisRoute.regex)){
          var splats = {};
          for (i = 1; i < m.length; i ++){
            splats[captures[i-1]] = m[i];
          }
          return splats;
        }
        else{
          return false;
        }
      }
    }
  
  
          //           
        // var routeParts = window.location.hash.split("/");
        // // remove the '#'
        // routeParts.reverse() && routeParts.pop() && routeParts.reverse();
        //   routes[route] = {}
        //   
        
    var Router = {
        compiledRoutes : [],
        
        route : function(){
          var routableHash = window.location.hash.replace(/^#/, '');
          
          for (n = 0; n < Router.compiledRoutes.length; n ++){
            if(splat = Router.compiledRoutes[n].route.doesMatch(routableHash)){
              Router.compiledRoutes[n].action(splat);
            }
          }
        },
        
        addRoute : function(route, action){
          var patterns = Router.extractPatterns(route);
          var compiled = Router.compileRoute(patterns);
          Router.compiledRoutes.push({action: action, route: compiled});
        },
        
        compileRoute : function(patterns){
          var regexString = "^";
          var wildCardNames = [];
          for (i = 0; i < patterns.length; i ++){
            regexString += "\/" + patterns[i].pattern;
            
            if(patterns[i].wildcard)
              wildCardNames.push(patterns[i].name);
          }
          var r = new RegExp(regexString);
          return new CompiledRoute(r, wildCardNames);
        },
        
        extractPatterns : function(route){
          var parts = route.split("/")

          var urlParts = []
          
          for (i = 1; i < parts.length; i ++){
            if(m = parts[i].match(/:([a-z]*|[0-9]*)/))
              urlParts.push({wildcard : true, name : m[1], pattern : "([a-z]+|[0-9]+)"});
            else
              urlParts.push({wildcard : false, pattern : parts[i]});
          }
          
          return urlParts
        }
      }
      
    var Route = function(myRoute, action){
      Router.addRoute(myRoute, action);
    }
    Route("/posts/:id", function(params){
      $("h1").html("Post #" + params['id']);  
    })
    $(function() {
      Router.route();
      
      

      // // Route("/posts/:id", function(){});
      // // no splats Route("/say/*/to/*", function(){})
      // 

    })
  </script>
  <body>
    <h1></h1>
  </body>
</html>
